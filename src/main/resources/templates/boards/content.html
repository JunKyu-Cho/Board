<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시판</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <style>
        nav {
            width: 800px;
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid gray;
        }

        .container {
            width: 800px;
            padding: 15px;
        }

        section strong {
            display: inline-block;
            margin: 0 15px 0 5px;
            font-weight: normal;
        }

        .btn {
            cursor:pointer;
            width: 70px;
            height: 25px;
            text-decoration: none;
            text-align: center;
            border: 1px solid #000;
            background-color: #fff;
            color: #000;
            display: inline-block;
        }
        div {
           display: block;
        }

    </style>

    <script type="text/javascript">
        function writeReply() {
            var form = document.reply;
            form.action = "/reply/write";
            form.method ="post";
            form.submit();
        };

        function deleteReply(frm) {
            var form = document.forms[frm];
            form.action = "/reply/delete";
            form.method ="post";
            form.submit();
        };

        function replyModify(id) {

            var modifyForm = document.getElementById('modifyForm' + id);
            var divContent = document.getElementById('divContent' + id);

            <!-- 기존 댓글 안보이게. 수정할 textarea는 보이게 설정 -->
            modifyForm.style.display = 'block';
            divContent.style.display = 'none';


            var str = "";
            var children = divContent.children;
            for(var i = 0; i < children.length; i++) {
                if(i == (children.length - 1))
                    str += children[i].innerText;
                else
                    str += children[i].innerText + "\r\n";
            }

            <!-- 0: input(replyId), 1: input(contentId), 2: input(page), 3: textarea(content)  -->
            modifyForm.children[3].value = str;
        };

        function modifyClick(id) {
            var form = document.forms['modifyForm' + id];
            form.action = "/reply/modify";
            form.method ="post";
            form.submit();
        };

        function deleteContent() {
            var form = document.contentInfo;
            form.action = "/board/delete";
            form.method ="get";
            form.submit();
        };

        function modifyContent() {
            var form = document.contentInfo;
            form.action = "/board/modify";
            form.method ="post";
            form.submit();
        };

    </script>

</head>
<body>
    <nav>
        <div th:if="${session.userId != null}">
            <a href="/member/logout" class="btn" style="width: 80px">로그아웃</a>
        </div>
        <div th:unless="${session.userId != null}">
            <a href="/member/login" class="btn" style="width: 80px">로그인</a>
            <a href="/member/register" class="btn" style="width: 80px">회원가입</a>
        </div>
    </nav>

    <div class="container">
        <h2 style="text-align: center;">게시글</h2>

        <div >
            <article style="width: 100%">
                <!-- 타이틀 -->
                <header>
                    <h1 for="title" style="padding-left: 40px; font-size: 1.2em;">제목 : <th:bloack th:text="${board.title}"></th:bloack></h1>
                </header>

                <!-- 게시물 정보 -->
                <section style="padding: 0 0 10px; border-bottom: 1px solid #333;">
                    <a>작성자</a>
                    <strong th:text="${board.writer}"></strong>
                    <a>작성일</a>
                    <strong th:text="${board.regDate}"></strong>
                    <a>조회수</a>
                    <strong th:text="${board.viewCount}"></strong>
                </section>

                <!-- 수정, 삭제, 목록 버튼 -->
                <div style="margin: 0 0 10px; padding: 10px 0; height: 30px; padding-right: 20px">

                    <form name="contentInfo" style="float: right;">
                        <input type="hidden" name="id" th:value="${board.id}">
                        <input type="hidden" name="title" th:value="${board.title}">
                        <input type="hidden" name="content" th:value="${board.content}">
                        <input type="hidden" name="writer" th:value="${board.writer}">
                        <input type="hidden" name="page" th:value="${pageNo}">

                        <!-- session id값이 같아야 삭제가 가능 -->
                        <th:block th:if="${board.writer == session.userId}">
                            <a href="javascript:modifyContent();" class="btn">수정</a>
                            <a href="javascript:deleteContent();" class="btn">삭제</a>
                        </th:block>

                        <th:block th:if="${pageNo != null}">
                            <a th:href="@{/board(page=${pageNo})}" class="btn">목록</a>
                        </th:block>
                        <th:block th:unless="${pageNo != null}">
                            <a th:href="@{/board}" class="btn">목록</a>
                        </th:block>
                    </form>

                </div>

                <!-- 게시물 내용 -->
                <section>
                    <div style="height: auto; min-height: 200px; table-layout:fixed; word-break:break-all; border-bottom: 1px solid gray;"
                         th:utext="${board.content}" ></div>

                    <!-- 파일 다운로드 -->
                    <div th:if="${fileList} != null" style="padding: 10px 0; border-bottom: 1px solid gray;">
                        <strong>첨부파일 : </strong>
                        <th:block th:each="file : ${fileList}">
                            <a th:href="@{'/board/download/' + ${file.fileName}}" th:text="${file.oriFilename}"></a>
                        </th:block>
                    </div>


                </section>

                <!-- 댓글 -->
                <div style="margin-top: 50px;">
                    <!-- HashMap 반복 -->
                    <div style="padding: 0 0 10px; border-bottom: 1px solid #333;" th:each="map, i : ${replyList}">

                        <!-- reply 값 중 -->
                        <div th:each="reply : ${map.key}" style="margin-bottom: 10px">

                            <span style="margin-left: 20px; font-size: 12px; color: gray" th:text="${reply.writer}"></span>
                            <span style="margin-left: 20px; font-size: 12px; color: gray" th:text="${reply.regDate}"></span>

                            <th:block th:if="${session.userId == reply.writer}">
                                <!-- 댓글 마다 다른 폼이기 때문에 id 값을 달리 주기 위함 -->
                                <form th:id="'form'+${i.index}" style="float: right; padding-right: 20px">
                                    <input type="hidden" name="replyId" th:value="${reply.replyId}">
                                    <input type="hidden" name="contentId" th:value="${board.id}">
                                    <input type="hidden" name="page" th:value="${pageNo}">

                                    <a th:onclick="|javascript:replyModify(${i.index})|" class="btn" style="width: 40px; height: 25px; margin-top: 5px">수정</a>
                                    <!-- 해당 폼의 submit을 수행 하기 위해 파라미터 값으로 폼 id 전달 -->
<!--                                    <a th:onclick="|javascript:deleteReply('form'+${reply.replyId})|" class="btn" style="width: 40px; height: 25px; margin-top: 5px">삭제</a>-->
                                    <a th:onclick="|javascript:deleteReply('form'+${i.index})|" class="btn" style="width: 40px; height: 25px; margin-top: 5px">삭제</a>
                                </form>

                                <!-- 댓글 수정 -->
                                <form th:id="'modifyForm'+${i.index}" style="display: none; margin-top: 20px;">
                                    <input type="hidden" name="replyId" th:value="${reply.replyId}">
                                    <input type="hidden" name="contentId" th:value="${board.id}">
                                    <input type="hidden" name="page" th:value="${pageNo}">

                                    <textarea name="content" rows="3" style="resize: none; box-sizing: border-box; overflow: auto; padding: 5px; width: 750px"></textarea>
                                    <a th:onclick="|javascript:modifyClick(${i.index})|" class="btn" style="width: 40px; height: 25px; margin-top: 30px; float: right;">확인</a>
                                </form>
                            </th:block>
                        </div>
                        <!-- List<String> 값 중 -->
                        <div th:id="'divContent'+${i.index}" >
                            <th:block th:each="content : ${map.value}">
                                <p style="margin: 0 10px" th:text="${content}" visibility></p>
                            </th:block>
                        </div>
                    </div>
                </div>

                <!-- 댓글 달기 -->
                <form name="reply" style="padding: 10px 0; width: 100%">
                    <!-- 게시물 ID, User ID 값 Hidden -->
                    <input type="hidden" name="contentId" th:value="${board.id}">
                    <input type="hidden" name="writer" th:value="${session.userId}">
                    <input type="hidden" name="page" th:value="${pageNo}">

                    <!-- 로그인 상태 일 경우 만 -->
                    <th:block th:if="${session.userId != null}">
                        <textarea id="content" name="content" rows="3" style="resize: none; box-sizing: border-box; overflow: auto; padding: 5px; width: 100%"></textarea>
                        <div style="text-align: right">
                            <a href="javascript:writeReply();" class="btn">등록</a>
                        </div>
                    </th:block>
                </form>
            </article>
        </div>
    </div>
</body>
</html>